# План дій для прозорого HID‑проксі

Джерела еталонних дампів: `Docs/Reports/LogitechB100 mouse.txt`, `Docs/Reports/Keyboard.txt`, `Docs/Reports/Gamepad.txt`, `Docs/Reports/LogitechPRO.txt`, `Docs/Reports/SiliconWin mouse.txt`.

1) **Мульти‑HID підтримка**: підняти `CFG_TUD_HID` (A_device) до ≥ `CFG_TUH_HID` (нині 4); розширити масиви у `remote_storage.*`; на B_host обрізати/логувати інтерфейси понад ліміт. Потрібно для Logitech PRO (3 HID) та клавіатури з двома інтерфейсами.
2) **Ліміти дескрипторів/буферів**: збільшити `PROXY_MAX_DESC_SIZE` (й похідні буфери/кеші) мінімум до 1 KB; перевірити, що чанкування PF_DESC_* лишається коректним. У дампах є великі HID звіти (SiliconWin 0x77, Logitech PRO 0x53, Gamepad 0x65).
3) **Рядки без фолбеків**: прибрати примусові empty/fake рядки для idx>2, дозволити fetch усіх індексів; allowlist формувати з device/config дескрипторів. Враховувати: деякі пристрої не мають manufacturer/serial (Keyboard, Gamepad).
4) **Control/Output прозорість**: перевірити повний шлях SET_REPORT/GET_REPORT/SET_IDLE для ReportID‑based пристроїв (Gamepad має Output, SiliconWin має кілька Report ID). Додати тест/логіку для коректної довжини та тайм‑аутів без зайвих ресетів.
5) **Transport надійність**: додати CRC16/перевірку довжини у кадрах, флаш/UNMOUNT при помилках; за потреби збільшити `PROTO_MAX_FRAME_SIZE` для довгих репортів/Feature. (✅ CRC повернуто, при помилці CRC/довжини — повний флаш RX і скидання READY)
6) **DONE/READY стабілізація**: зберегти захист від нескінченних DEVICE_RESET при ретраях PF_DESC_DONE, додати явний тайм‑аут/лічильник з fallback (UNMOUNT+RESET) при відсутності READY.
7) **Валідація прозорості**: після змін зібрати дамп дескрипторів/рядків із проксі та дифнути з оригінальними файлами вище (відмінності допускаються лише для bMaxPacketSize0 clamp і службових змін). Фіксувати результати у Docs.
8) **Тести**: розширити harness/integration на multi‑HID, великі HID дескриптори, рядки >2, тайм‑аут READY/DONE, Output‑звіт Gamepad та багаторепортні пристрої (SiliconWin).

## Нотатки після перевірки Logitech PRO (test 442)
- Дескриптори пристрою/конфіг збігаються з оригіналом.
- Відсутні рядки idx3 (Serial) і idx4 (iConfiguration) — зараз падаємо в STALL/порожній дескриптор. Треба виконати пункт 3 (зняти фолбеки idx>2, дозволити fetch всіх індексів) і перевірити строкові відповіді.
- Control для itf1/itf2: PF_CTRL_SET_IDLE/SET_REPORT з PC ігноруються на B_host через відсутній slot (mount лише itf0). Потрібно забезпечити монтування/слоти для всіх HID інтерфейсів або обробку control без mount.
- На A_device помічено `invalid frame length=49156` — ще один аргумент до пункту 5 (CRC/перевірка довжини/скидання буфера).
## Статус після спроб з CRC та ресинком
- CRC тимчасово відключено через несумісність; повернута жорстка очистка буфера на помилках довжини/парсу, READY скидається.
- PF_INPUT тепер блокується на B_host до READY, але пакетів з len=21 багато, tud_hid_report busy => треба або чергу на A_device, або дроселювання на B_host.
- Залишається артефакт у дереві (itf2 як “10-USB-устройство ввода”) — після стабілізації транспорту й усунення busy-drop треба пересняти дамп.
