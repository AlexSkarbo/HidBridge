# WebRTC Video Peer

Goal: move towards real-time video via WebRTC.
Current implementation already publishes a synthetic VP8 track for connectivity validation.

## Components

- `HidControlServer`: signaling relay (`/ws/webrtc`) + room/ICE/config endpoints under `/status/*`
- `WebRtcVideoPeer` (helper): `Tools/WebRtcVideoPeer` (Go + Pion + ffmpeg test source)
- `HidControl.Web`: demo UI (rooms browser + DataChannel tester)
- Signaling path split details: `Docs/webrtc_signaling_paths.md`

## Rooms

Video rooms are a separate namespace (recommended):

- Default video room: `video`
- Generated video rooms: `hb-v-<deviceIdShort>-<rand>`

Where:
- `<deviceIdShort>` is derived from `HidUartClient.GetDeviceIdHex()` (first 8 hex chars) and is currently tied to the UART-connected HID bridge MCU (typically `B_host`).
- If the device id is not known yet, the generator uses `unknown`.
- `<rand>` is a short random base36 suffix to avoid collisions.

## Endpoints

- List video rooms: `GET /status/webrtc/video/rooms`
- Create a video room (and start helper): `POST /status/webrtc/video/rooms` (optional body: `{ "room": "..." }`)
- Delete a video room helper: `DELETE /status/webrtc/video/rooms/{room}`
  - Note: deleting the default room `video` is blocked (`cannot_delete_video`).

## Helper Auto-Start

`HidControlServer` can auto-start the video helper on boot:

```json
{
  "webRtcVideoPeerAutoStart": true,
  "webRtcVideoPeerRoom": "video",
  "webRtcVideoPeerStun": "stun:stun.l.google.com:19302"
}
```

## Current Behavior

- Helper joins room and accepts offer.
- Helper publishes VP8 video track generated by `ffmpeg` test source.
- Helper keeps DataChannel echo for control/debug payloads.
- Helper process is long-running and reconnects to signaling after transient transport failures.

## Optional Room Registry Persistence

Video rooms can be restored after server restart with:

```json
{
  "webRtcRoomsPersistEnabled": true,
  "webRtcRoomsStorePath": "webrtc_rooms.json",
  "webRtcRoomsPersistTtlSeconds": 86400
}
```

## Current Limitations

- Video is synthetic (test source), not real camera/screen yet.
- Full production capture pipeline and codec policy are next milestones.
